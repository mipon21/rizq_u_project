name: Build iOS App

on:
  push:
    branches: [ main ]
    paths:
      - 'lib/**'
      - 'pubspec.yaml'
      - 'ios/**'
      - '.github/workflows/ios-build.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'lib/**'
      - 'pubspec.yaml'
      - 'ios/**'

jobs:
  build-ios:
    runs-on: macos-latest
    name: Build iOS App

    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
    
    - name: Setup Xcode
      run: |
        sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
        sudo xcodebuild -license accept
    
    - name: Get dependencies
      run: |
        flutter doctor -v
        flutter pub get --verbose
        flutter pub deps
    
    - name: Clean and Setup
      run: |
        flutter clean
        cd ios
        rm -rf Pods Podfile.lock
        rm -rf ~/Library/Developer/Xcode/DerivedData
        cd ..
    
    - name: Ensure Flutter Framework
      run: |
        # Ensure Flutter framework is properly cached
        flutter precache --ios
        # Verify Flutter framework location
        echo "Flutter root: $FLUTTER_ROOT"
        ls -la $FLUTTER_ROOT/bin/cache/artifacts/engine/ios*
    
    - name: Setup iOS with Flutter
      run: |
        cd ios
        # Ensure Podfile has correct platform version
        if ! grep -q "platform :ios, '15.5'" Podfile; then
          sed -i '' 's/platform :ios, '\''13.0'\''/platform :ios, '\''15.5'\''/' Podfile
        fi
        # Install pods with verbose output
        pod install --repo-update --verbose
        cd ..
    
    - name: Debug Pod Installation
      run: |
        cd ios
        echo "=== Podfile contents ==="
        cat Podfile
        echo "=== Pods directory ==="
        ls -la Pods/
        echo "=== Flutter pods ==="
        find Pods/ -name "*Flutter*" -type d
        echo "=== Generated.xcconfig ==="
        cat ../Flutter/Generated.xcconfig
        cd ..
    
    - name: Build iOS App Bundle
      run: |
        flutter clean
        flutter pub get
        # Build with explicit Flutter framework path and additional flags
        flutter build ios --release --no-codesign --dart-define=CI=true --verbose --build-number=${{ github.run_number }}
      env:
        CI: true
        FLUTTER_BUILD_NUMBER: ${{ github.run_number }}
        FLUTTER_ROOT: ${{ env.FLUTTER_ROOT }}
    
    - name: Create Export Options Plist
      run: |
        cd ios
        cat > exportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>development</string>
            <key>compileBitcode</key>
            <false/>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <false/>
            <key>signingStyle</key>
            <string>manual</string>
            <key>stripSwiftSymbols</key>
            <true/>
        </dict>
        </plist>
        EOF
        cd ..
    
    - name: Create IPA Archive
      run: |
        cd ios
        # Create archive without code signing
        xcodebuild -workspace Runner.xcworkspace -scheme Runner -configuration Release -archivePath build/Runner.xcarchive archive CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO
        # Export IPA without code signing
        xcodebuild -exportArchive -archivePath build/Runner.xcarchive -exportPath build/ipa -exportOptionsPlist exportOptions.plist
        cd ..
    
    - name: Upload iOS App Bundle
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: ios-app-bundle-${{ github.run_number }}
        path: build/ios/iphoneos/Runner.app
        retention-days: 30
    
    - name: Upload IPA File
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: ios-ipa-${{ github.run_number }}
        path: ios/build/ipa/Runner.ipa
        retention-days: 30 